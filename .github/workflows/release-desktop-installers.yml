name: Release Desktop Installers

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  validate:
    name: Validate
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Validate
        run: npm run quality:gate

  package-installers:
    name: Package (${{ matrix.platform }})
    needs: validate
    runs-on: ${{ matrix.os }}
    environment: release
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            platform: macOS
            package_command: npm run desktop:package:mac

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Set app version from tag
        shell: bash
        env:
          TAG_NAME: ${{ github.ref_name }}
        run: |
          VERSION="${TAG_NAME#v}"
          npm version "${VERSION}" --no-git-tag-version --allow-same-version

      - name: Prepare macOS signing credentials
        if: matrix.os == 'macos-latest'
        shell: bash
        env:
          MACOS_CERTIFICATE_P12_BASE64: ${{ secrets.MACOS_CERTIFICATE_P12_BASE64 }}
          MACOS_CERTIFICATE_PASSWORD: ${{ secrets.MACOS_CERTIFICATE_PASSWORD }}
          APPLE_NOTARY_KEY_P8: ${{ secrets.APPLE_NOTARY_KEY_P8 }}
          APPLE_NOTARY_KEY_ID: ${{ secrets.APPLE_NOTARY_KEY_ID }}
          APPLE_NOTARY_ISSUER_ID: ${{ secrets.APPLE_NOTARY_ISSUER_ID }}
        run: |
          set -euo pipefail

          for required_var in MACOS_CERTIFICATE_P12_BASE64 MACOS_CERTIFICATE_PASSWORD APPLE_NOTARY_KEY_P8 APPLE_NOTARY_KEY_ID APPLE_NOTARY_ISSUER_ID; do
            if [ -z "${!required_var:-}" ]; then
              echo "::error title=Missing secret::${required_var} is required for macOS signed release builds."
              exit 1
            fi
          done

          CERT_PATH="${RUNNER_TEMP}/macos-signing-cert.p12"
          printf '%s' "${MACOS_CERTIFICATE_P12_BASE64}" | base64 -D > "${CERT_PATH}"

          NOTARY_KEY_PATH="${RUNNER_TEMP}/AuthKey_${APPLE_NOTARY_KEY_ID}.p8"
          printf '%s' "${APPLE_NOTARY_KEY_P8}" > "${NOTARY_KEY_PATH}"

          chmod 600 "${CERT_PATH}" "${NOTARY_KEY_PATH}"

          {
            echo "CSC_LINK=${CERT_PATH}"
            echo "CSC_KEY_PASSWORD=${MACOS_CERTIFICATE_PASSWORD}"
            echo "APPLE_API_KEY=${NOTARY_KEY_PATH}"
            echo "APPLE_API_KEY_ID=${APPLE_NOTARY_KEY_ID}"
            echo "APPLE_API_ISSUER=${APPLE_NOTARY_ISSUER_ID}"
            echo "CSC_IDENTITY_AUTO_DISCOVERY=false"
          } >> "${GITHUB_ENV}"

      - name: Validate macOS signing certificate type
        if: matrix.os == 'macos-latest'
        shell: bash
        env:
          CSC_LINK: ${{ env.CSC_LINK }}
          CSC_KEY_PASSWORD: ${{ env.CSC_KEY_PASSWORD }}
        run: |
          set -euo pipefail

          if [ -z "${CSC_LINK:-}" ] || [ ! -f "${CSC_LINK}" ]; then
            echo "::error title=Invalid certificate path::CSC_LINK is not set to a valid file."
            exit 1
          fi

          CERT_SUBJECT="$(
            openssl pkcs12 -in "${CSC_LINK}" -clcerts -nokeys -passin "pass:${CSC_KEY_PASSWORD}" \
            | openssl x509 -noout -subject -nameopt utf8 2>/dev/null
          )"

          if [[ "${CERT_SUBJECT}" != *"Developer ID Application"* ]]; then
            echo "::error title=Invalid macOS signing certificate::MACOS_CERTIFICATE_P12_BASE64 must contain a Developer ID Application certificate."
            echo "::error::Current certificate subject: ${CERT_SUBJECT}"
            exit 1
          fi

      - name: Build installer (macOS)
        if: matrix.os == 'macos-latest'
        shell: bash
        run: |
          ulimit -n 10240
          ${{ matrix.package_command }}

      - name: Notarize and staple macOS DMG
        if: matrix.os == 'macos-latest'
        shell: bash
        run: |
          set -euo pipefail

          DMG_PATH="$(find dist/installers -maxdepth 1 -type f -name '*.dmg' | head -n 1)"
          if [ -z "${DMG_PATH}" ]; then
            echo "::error::DMG installer was not found under dist/installers."
            exit 1
          fi

          for required_var in APPLE_API_KEY APPLE_API_KEY_ID APPLE_API_ISSUER; do
            if [ -z "${!required_var:-}" ]; then
              echo "::error title=Missing notarization credential::${required_var} is required to notarize the DMG artifact."
              exit 1
            fi
          done

          xcrun notarytool submit "${DMG_PATH}" \
            --key "${APPLE_API_KEY}" \
            --key-id "${APPLE_API_KEY_ID}" \
            --issuer "${APPLE_API_ISSUER}" \
            --wait

          xcrun stapler staple "${DMG_PATH}"

      - name: Verify macOS code signing and notarization
        if: matrix.os == 'macos-latest'
        shell: bash
        run: |
          set -euo pipefail

          APP_PATH="$(find dist/installers -type d -name 'Local Playground.app' | head -n 1)"
          if [ -z "${APP_PATH}" ]; then
            echo "::error::Signed app bundle was not found under dist/installers."
            exit 1
          fi

          DMG_PATH="$(find dist/installers -maxdepth 1 -type f -name '*.dmg' | head -n 1)"
          if [ -z "${DMG_PATH}" ]; then
            echo "::error::DMG installer was not found under dist/installers."
            exit 1
          fi

          codesign --verify --deep --strict --verbose=2 "${APP_PATH}"
          spctl --assess --type execute --verbose=4 "${APP_PATH}"
          xcrun stapler validate "${APP_PATH}"
          xcrun stapler validate "${DMG_PATH}"

      - name: Validate macOS updater metadata
        if: matrix.os == 'macos-latest'
        shell: bash
        run: |
          set -euo pipefail

          LATEST_MAC_YML_PATH="$(find dist/installers -maxdepth 1 -type f -name 'latest-mac*.yml' | head -n 1)"
          if [ -z "${LATEST_MAC_YML_PATH}" ]; then
            echo "::error::Updater metadata file (latest-mac.yml) was not found under dist/installers."
            exit 1
          fi

          ZIP_PATH="$(find dist/installers -maxdepth 1 -type f -name '*.zip' | head -n 1)"
          if [ -z "${ZIP_PATH}" ]; then
            echo "::error::ZIP installer was not found under dist/installers."
            exit 1
          fi


      - name: Upload macOS installers
        if: matrix.os == 'macos-latest'
        uses: actions/upload-artifact@v4
        with:
          name: installers-macos
          path: |
            dist/installers/*.dmg
            dist/installers/*.zip
            dist/installers/*.yml
            dist/installers/*.blockmap
          if-no-files-found: error

  release:
    name: Publish Release Assets
    needs: package-installers
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download installers
        uses: actions/download-artifact@v4
        with:
          path: release-assets

      - name: Generate release integrity artifacts
        env:
          RELEASE_SIGNING_PRIVATE_KEY_PEM: ${{ secrets.RELEASE_SIGNING_PRIVATE_KEY_PEM }}
          RELEASE_SIGNING_PRIVATE_KEY_PASSPHRASE: ${{ secrets.RELEASE_SIGNING_PRIVATE_KEY_PASSPHRASE }}
        run: |
          set -euo pipefail

          mapfile -t INSTALLERS < <(find release-assets -type f \( -name '*.dmg' -o -name '*.zip' -o -name '*.exe' \) | sort)
          if [ "${#INSTALLERS[@]}" -eq 0 ]; then
            echo "::error::No installer assets were found for checksum/signature generation."
            exit 1
          fi

          CHECKSUM_FILE="release-assets/SHA256SUMS.txt"
          : > "${CHECKSUM_FILE}"

          for asset in "${INSTALLERS[@]}"; do
            checksum="$(sha256sum "${asset}" | awk '{print $1}')"
            asset_name="$(basename "${asset}")"
            printf '%s  %s\n' "${checksum}" "${asset_name}" >> "${CHECKSUM_FILE}"
          done

          if [ -n "${RELEASE_SIGNING_PRIVATE_KEY_PEM:-}" ]; then
            PRIVATE_KEY_PATH="${RUNNER_TEMP}/release-signing-private-key.pem"
            printf '%s' "${RELEASE_SIGNING_PRIVATE_KEY_PEM}" > "${PRIVATE_KEY_PATH}"
            chmod 600 "${PRIVATE_KEY_PATH}"

            PASSIN_ARGS=()
            if [ -n "${RELEASE_SIGNING_PRIVATE_KEY_PASSPHRASE:-}" ]; then
              PASSIN_ARGS=(-passin env:RELEASE_SIGNING_PRIVATE_KEY_PASSPHRASE)
            fi

            PUBLIC_KEY_PATH="release-assets/release-signing-key.pem"
            openssl pkey -in "${PRIVATE_KEY_PATH}" "${PASSIN_ARGS[@]}" -pubout -out "${PUBLIC_KEY_PATH}"

            for asset in "${INSTALLERS[@]}" "${CHECKSUM_FILE}"; do
              openssl dgst -sha256 -sign "${PRIVATE_KEY_PATH}" "${PASSIN_ARGS[@]}" -out "${asset}.sig" "${asset}"
            done

            openssl dgst -sha256 -verify "${PUBLIC_KEY_PATH}" -signature "${CHECKSUM_FILE}.sig" "${CHECKSUM_FILE}" >/dev/null
          else
            echo "RELEASE_SIGNING_PRIVATE_KEY_PEM is not configured; publishing checksums without detached signatures."
          fi

      - name: Publish release notes and assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG_NAME: ${{ github.ref_name }}
        run: |
          mapfile -t ASSETS < <(find release-assets -type f | sort)
          if [ "${#ASSETS[@]}" -eq 0 ]; then
            echo "No installer assets were found."
            exit 1
          fi

          cat > release-notes.md <<'EOF'
          ## Local Playground

          Desktop installers and updater metadata for macOS are attached to this release.

          ### Run from Source (Copy & Paste)

          ```bash
          git clone https://github.com/anaregdesign/local-playground.git
          cd local-playground
          npm install
          az login
          npm run dev
          ```

          Open: `http://localhost:5173`

          ### Installer Assets
          - Includes `latest-mac.yml` for in-app update checks.

          ### Integrity Assets
          - `SHA256SUMS.txt` is always published for installer SHA-256 checksums.
          - `release-signing-key.pem` and detached signatures (`<asset>.sig`) are published only when release signing is configured.

          ### Platform Trust
          - macOS artifacts are Developer ID signed and notarized.
          EOF

          for asset in "${ASSETS[@]}"; do
            printf -- '- `%s`\n' "$(basename "${asset}")" >> release-notes.md
          done

          if gh release view "${TAG_NAME}" --repo "${GITHUB_REPOSITORY}" >/dev/null 2>&1; then
            gh release edit "${TAG_NAME}" --repo "${GITHUB_REPOSITORY}" --title "${TAG_NAME}" --notes-file release-notes.md
          else
            gh release create "${TAG_NAME}" --repo "${GITHUB_REPOSITORY}" --title "${TAG_NAME}" --notes-file release-notes.md
          fi

          gh release upload "${TAG_NAME}" --repo "${GITHUB_REPOSITORY}" "${ASSETS[@]}" --clobber
